# AgenticDSL v3.0 与 v2.3 差异文档  
**——面向 AI 原生动态 DAG 的范式对齐与增强**

> 本文件系统对比 AgenticDSL v3.0 草案与 v2.3 规范的异同，明确 v3.0 的演进方向：**保留并强化 v2.3 的先进理念，澄清模糊点，标准化工程实践，拒绝向后兼容妥协**。

---

## 一、总体原则

| 项目 | v2.3 | v3.0 |
|------|------|------|
| **核心范式** | ✅ 执行驱动生成 + 动态可生长 DAG | ✅ 完全继承并强化 |
| **LLM 角色** | 工作流程序员（生成子图） | ✅ 同左，但更强调契约与意图结构化 |
| **兼容性策略** | — | ❌ **不保证向后兼容**；以“未来正确性”为优先 |
| **文件模型** | 多块 `### AgenticDSL '/path'` | ✅ **完全保留**，作为唯一逻辑单元 |
| **静态 vs 动态** | 动态为主，静态为特例 | ✅ 明确：**静态 = 预注册的契约化子图（`/lib/**`）** |

---

## 二、关键差异详表

### 1. 文件与结构模型

| 特性 | v2.3 | v3.0 | 变更类型 |
|------|------|------|--------|
| `.agent.md` 定位 | 未明确定义 | ✅ **明确定义为“子图块的物理打包格式”** | 澄清 |
| 路径命名空间 | 隐式使用 `/lib/**` | ✅ **显式规范命名空间语义**：<br> - `/lib/**`：静态标准库（强制 `signature`）<br> - `/dynamic/**`：运行时生成<br> - `/main/**`：主流程 | 增强 |
| 子图签名（`signature`） | “可声明” | ✅ **`/lib/**` 子图强制声明 `signature`** | 强化契约 |
| 依赖管理（`requires`） | 支持但未强调 | ✅ **明确依赖解析时机与循环检测** | 工程化 |

---

### 2. 状态与上下文模型

| 特性 | v2.3 | v3.0 | 变更类型 |
|------|------|------|--------|
| 上下文结构 | 隐式（无 schema） | ⚠️ **保留隐式上下文，但鼓励通过 `signature`/`assign` 约束字段** | 澄清（非强制 schema） |
| 合并策略 | ✅ 字段级、可继承 | ✅ 完全保留 | 无变更 |
| 未声明字段写入 | 允许 | ✅ **仍允许，但 trace 中记录 warning**（若来自 `/lib/**` 则报错） | 安全增强 |

> 💡 **说明**：v3.0 **未引入顶层 `state.schema`**，以保持与 v2.3 动态灵活性一致。状态契约通过 `signature.inputs/outputs` 和 `assign` 显式表达。

---

### 3. 节点与控制流

| 特性 | v2.3 | v3.0 | 变更类型 |
|------|------|------|--------|
| 节点类型 | ✅ `start`, `end`, `assign`, `llm_call`, `tool_call`, `codelet` | ✅ **完全保留所有类型** | 无变更 |
| `human` 节点 | ❌ 无原生支持（需用 `tool_call` 模拟） | ✅ **新增原生 `human` 节点类型**（含 `roles`, `timeout`, `fields`） | 新增 |
| `input` 节点 | ❌ 无 | ❌ **v3.0 草案中移除**（因 `assign` + 外部注入已足够） | 澄清 |
| 显式 `edges` | ❌ 无 | ❌ **v3.0 草案中移除**（坚持 `next` + `wait_for` 为唯一控制流） | 澄清 |
| `end` 软终止 | ✅ 支持 | ✅ **强化语义：必须返回调用者父图** | 澄清 |

---

### 4. 动态 DAG 与 LLM 协同

| 特性 | v2.3 | v3.0 | 变更类型 |
|------|------|------|--------|
| `llm_call` 生成格式 | ✅ `### AgenticDSL '/path'` 块 | ✅ **完全保留** | 无变更 |
| LLM 生成目标 | 子图片段 | ✅ **明确禁止生成完整 `.agent.md`**；必须输出路径块 | 澄清 |
| 可用库注入 | ✅ `available_subgraphs` | ✅ **强化：必须包含 `signature`** | 增强 |
| LLM 意图 | ✅ `<!-- LLM_INTENT: {...} -->` | ✅ 完全保留 | 无变更 |

---

### 5. 安全与可观测性

| 特性 | v2.3 | v3.0 | 变更类型 |
|------|------|------|--------|
| 权限模型 | ✅ `permissions` | ✅ 完全保留 | 无变更 |
| 沙箱 | ✅ 最小权限 | ✅ **明确 `/lib/**` 启用沙箱** | 澄清 |
| Trace 结构 | ✅ 包含 `context_delta`, `llm_intent` | ✅ **修正字段名空格问题**（如 `"trace_id "` → `"trace_id"`） | 修复 |
| 标准库标签 | — | ✅ **自动附加 `node_type: "standard_library"`** | 增强 |

---

### 6. 移除或弱化的特性（v2.3 → v3.0）

| v2.3 特性 | v3.0 状态 | 原因 |
|----------|----------|------|
| 对 `codelet` inline Python 的宽松支持 | ⚠️ **保留但强调沙箱限制** | 安全优先，但不移除能力 |
| 无 `signature` 的 `/lib/**` 子图 | ❌ **禁止** | 破坏契约精神 |
| 模糊的“静态编排”概念 | ✅ **重新定义为“预注册子图”** | 范式统一 |

---

## 三、v3.0 新增核心能力

| 能力 | 说明 |
|------|------|
| **原生 `human` 节点** | 支持角色、超时、字段绑定、审核流程 |
| **命名空间语义标准化** | `/lib/**` = 契约库，`/dynamic/**` = 运行时生成 |
| **标准库自动标签** | 便于监控、审计、计费 |
| **Trace 字段标准化** | 修复 v2.3 中的格式瑕疵（如尾随空格） |
| **依赖图启动校验** | 防止运行时缺失依赖 |

---

## 四、总结：v3.0 是 v2.3 的“范式精炼版”

- **保留全部先进理念**：动态 DAG、执行驱动生成、契约化标准库、安全沙箱、结构化 trace
- **澄清模糊设计**：命名空间、终止语义、LLM 生成目标
- **增强工程实践**：依赖管理、可观测性、错误诊断
- **拒绝历史包袱**：不兼容旧文件格式（如无路径块的 YAML），不支持无契约复用

> **v3.0 不是新语言，而是 v2.3 的“生产就绪版”**。  
> 它让 AgenticDSL 从“实验性 DSL”走向“AI 原生基础设施”。

---  
**附：迁移建议**  
- 所有 v2.3 有效文件（含路径块）**可直接在 v3.0 运行**  
- 仅需为 `/lib/**` 子图补充 `signature`  
- 避免使用未声明字段（将触发 warning）
