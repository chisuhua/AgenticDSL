# AgenticDSL v3.1 è§„èŒƒ  
**å®‰å…¨ Â· å¯ç»ˆæ­¢ Â· å¯è°ƒè¯• Â· å¯å¤ç”¨ Â· å¯å¥‘çº¦ Â· å¯éªŒè¯**

---
## ä¸€ã€æ ¸å¿ƒç†å¿µä¸å®šä½

### 1.1 å®šä½
AgenticDSL æ˜¯ä¸€å¥— **AI-Native çš„å£°æ˜å¼åŠ¨æ€ DAG è¯­è¨€**ï¼Œä¸“ä¸ºå•æ™ºèƒ½ä½“åŠæœªæ¥å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè®¾è®¡ï¼Œæ”¯æŒï¼š
- **LLM å¯ç”Ÿæˆ**ï¼šå¤§æ¨¡å‹èƒ½è¾“å‡ºç»“æ„åŒ–ã€å¯æ‰§è¡Œçš„å­å›¾
- **å¼•æ“å¯æ‰§è¡Œ**ï¼šç¡®å®šæ€§è°ƒåº¦ã€çŠ¶æ€åˆå¹¶ã€é¢„ç®—æ§åˆ¶
- **DAG å¯åŠ¨æ€ç”Ÿé•¿**ï¼šè¿è¡Œæ—¶ç”Ÿæˆæ–°å­å›¾ï¼Œæ”¯æŒæ€ç»´æµä¸è¡ŒåŠ¨æµ
- **æ ‡å‡†åº“å¯å¥‘çº¦å¤ç”¨**ï¼š`/lib/**` å¸¦ç­¾åï¼Œæœ€å°æƒé™æ²™ç®±
- **æ¨ç†å¯éªŒè¯è¿›åŒ–**ï¼šé€šè¿‡ `assert`ã€Traceã€`archive_to` å®ç°é—­ç¯ä¼˜åŒ–

### 1.2 æ ¹æœ¬èŒƒå¼
| è§’è‰² | èŒè´£ |
|------|------|
| **LLM** | ç¨‹åºå‘˜ï¼šåŸºäºçœŸå®çŠ¶æ€ç”Ÿæˆå¯éªŒè¯å­å›¾ |
| **æ‰§è¡Œå™¨** | è¿è¡Œæ—¶ï¼šç¡®å®šæ€§è°ƒåº¦ã€çŠ¶æ€åˆå¹¶ã€é¢„ç®—æ§åˆ¶ |
| **ä¸Šä¸‹æ–‡** | å†…å­˜ï¼šç»“æ„å¯å¥‘çº¦ã€åˆå¹¶å¯ç­–ç•¥ã€å†²çªå¯è¯Šæ–­ |
| **DAG** | ç¨‹åºï¼šå›¾å¯å¢é‡æ¼”åŒ–ï¼Œæ”¯æŒè¡ŒåŠ¨æµä¸æ€ç»´æµ |
| **æ ‡å‡†åº“** | SDKï¼š`/lib/**` å¿…é¡»å¸¦ `signature`ï¼Œæœ€å°æƒé™æ²™ç®± |

### 1.3 è®¾è®¡åŸåˆ™
- **ç¡®å®šæ€§ä¼˜å…ˆ**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»åœ¨æœ‰é™æ—¶é—´å†…å®Œæˆï¼Œç¦æ­¢å¼‚æ­¥å›è°ƒ
- **å¥‘çº¦é©±åŠ¨**ï¼šæ¥å£å¿…é¡»å£°æ˜ï¼Œè°ƒç”¨å¿…é¡»éªŒè¯
- **æœ€å°æƒé™**ï¼šèŠ‚ç‚¹/å­å›¾éœ€æ˜¾å¼å£°æ˜æ‰€éœ€æƒé™
- **å¯ç»ˆæ­¢æ€§**ï¼šå…¨å±€é¢„ç®—æ§åˆ¶ï¼Œé˜²æ­¢æ— é™å¾ªç¯æˆ–ç”Ÿæˆ
- **å¯è§‚æµ‹æ€§**ï¼šæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆç»“æ„åŒ– Traceï¼Œæ”¯æŒè°ƒè¯•ä¸è®­ç»ƒ

---

## äºŒã€èŠ‚ç‚¹æŠ½è±¡å±‚çº§ï¼ˆv3.1 æ ¸å¿ƒå¢å¼ºï¼‰

AgenticDSL èŠ‚ç‚¹åˆ†ä¸ºä¸‰å±‚ï¼Œç¡®ä¿è¯­ä¹‰æ¸…æ™°ä¸å¯æ¼”è¿›æ€§ï¼š

| å±‚çº§ | è¯´æ˜ | çº¦æŸ |
|------|------|------|
| **1. æ‰§è¡ŒåŸè¯­å±‚ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰** | è§„èŒƒå†…ç½®ã€ä¸å¯æ‰©å±•çš„æœ€å°æ“ä½œå•å…ƒ | ç¦æ­¢ç”¨æˆ·è‡ªå®šä¹‰æ–°ç±»å‹ |
| **2. æ¨ç†åŸè¯­å±‚ï¼ˆè§„èŒƒå­å›¾ï¼‰** | è§„èŒƒæä¾›çš„ç¨³å®šæ¨ç†æ¨¡å¼å®ç° | è·¯å¾„ï¼š`/lib/reasoning/**`ï¼Œç‰ˆæœ¬ç¨³å®šï¼Œç”±è§„èŒƒç»´æŠ¤ |
| **3. çŸ¥è¯†åº”ç”¨å±‚ï¼ˆæ ‡å‡†åº“å­å›¾ï¼‰** | ç”¨æˆ·/ç¤¾åŒºæ‰©å±•çš„é¢†åŸŸé€»è¾‘ | è·¯å¾„ï¼š`/lib/workflow/**`, `/lib/knowledge/**`ï¼Œéœ€å¸¦ `signature` |

> âœ… **æ‰€æœ‰å¤æ‚é€»è¾‘å¿…é¡»é€šè¿‡å­å›¾ç»„åˆå®ç°ï¼Œç¦æ­¢åœ¨å¶å­èŠ‚ç‚¹ä¸­ç¼–ç é«˜å±‚è¯­ä¹‰ã€‚**

---

## ä¸‰ã€æœ¯è¯­è¡¨ï¼ˆv3.1 æ–°å¢ï¼‰

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| **å­å›¾ï¼ˆSubgraphï¼‰** | ä¸€ä¸ªä»¥ `### AgenticDSL '/path'` å¼€å¤´çš„é€»è¾‘å•å…ƒï¼Œå¯è¢«å…¶ä»–èŠ‚ç‚¹è°ƒç”¨ |
| **åŠ¨æ€ç”Ÿé•¿ï¼ˆDynamic Growthï¼‰** | é€šè¿‡ `generate_subgraph` èŠ‚ç‚¹åœ¨è¿è¡Œæ—¶ç”Ÿæˆæ–°å­å›¾å¹¶æ³¨å†Œåˆ° `/dynamic/**` |
| **å¥‘çº¦ï¼ˆContractï¼‰** | ç”± `signature` å®šä¹‰çš„è¾“å…¥/è¾“å‡ºæ¥å£è§„èŒƒï¼Œç”¨äºè°ƒç”¨å‰æ ¡éªŒä¸è°ƒç”¨åéªŒè¯ |
| **è½¯ç»ˆæ­¢ï¼ˆSoft Terminationï¼‰** | å­å›¾æ‰§è¡Œç»“æŸæ—¶è¿”å›è°ƒç”¨è€…ä¸Šä¸‹æ–‡ï¼Œè€Œéç»ˆæ­¢æ•´ä¸ª DAG |
| **æ ¸å¿ƒæ ‡å‡†åº“ï¼ˆCore SDKï¼‰** | v3.1 å¼ºåˆ¶è¦æ±‚å®ç°çš„ `/lib/**` å­å›¾é›†åˆï¼ˆè§é™„å½• Cï¼‰ |
| **æ‰§è¡ŒåŸè¯­å±‚** | å†…ç½®å¶å­èŠ‚ç‚¹ï¼ˆå¦‚ `assign`, `assert`ï¼‰ï¼Œä¸å¯æ‰©å±• |
| **æ¨ç†åŸè¯­å±‚** | è§„èŒƒç»´æŠ¤çš„ `/lib/reasoning/**` å­å›¾ï¼Œå®ç°é€šç”¨æ¨ç†æ¨¡å¼ |

---

## å››ã€å…¬å…±å¥‘çº¦

### 4.1 ä¸Šä¸‹æ–‡æ¨¡å‹ï¼ˆContextï¼‰

- å…¨å±€å¯å˜å­—å…¸ï¼Œæ”¯æŒåµŒå¥—è·¯å¾„ï¼ˆå¦‚ `user.name`, `search_results[0].title`ï¼‰
- æ‰€æœ‰èŠ‚ç‚¹å…±äº«åŒä¸€ä¸Šä¸‹æ–‡ï¼›`assign` / `tool_call` / `codelet_call` çš„è¿”å›å€¼ **merge åˆ°è¯¥ä¸Šä¸‹æ–‡**
- å¹¶å‘èŠ‚ç‚¹ä½¿ç”¨ä¸Šä¸‹æ–‡å‰¯æœ¬ï¼Œæ‰§è¡Œå®ŒæˆåæŒ‰ç­–ç•¥ merge å›ä¸»ä¸Šä¸‹æ–‡

#### åˆå¹¶ç­–ç•¥ï¼ˆå­—æ®µçº§ã€å¯ç»§æ‰¿ï¼‰

| ç­–ç•¥ | è¡Œä¸ºè¯´æ˜ |
|------|--------|
| `error_on_conflict`ï¼ˆé»˜è®¤ï¼‰ | ä»»ä¸€å­—æ®µåœ¨å¤šä¸ªåˆ†æ”¯ä¸­è¢«å†™å…¥ â†’ æŠ¥é”™ç»ˆæ­¢ |
| `last_write_wins` | ä»¥æœ€åå®Œæˆçš„èŠ‚ç‚¹å†™å…¥å€¼ä¸ºå‡†ï¼ˆéç¡®å®šæ€§ï¼Œä»…ç”¨äºå¹‚ç­‰æ“ä½œï¼‰ |
| `deep_merge` | é€’å½’åˆå¹¶å¯¹è±¡ï¼›**æ•°ç»„æ›¿æ¢ï¼ˆéæ‹¼æ¥ï¼‰**ï¼›æ ‡é‡è¦†ç›–ï¼ˆéµå¾ª RFC 7396ï¼‰ |
| **`array_concat`**ï¼ˆv3.0 æ–°å¢ï¼‰ | **æ•°ç»„æ‹¼æ¥**ï¼ˆä¿ç•™é¡ºåºï¼Œå…è®¸é‡å¤ï¼‰ |
| **`array_merge_unique`**ï¼ˆv3.0 æ–°å¢ï¼‰ | æ•°ç»„æ‹¼æ¥ + å»é‡ï¼ˆåŸºäº JSON åºåˆ—åŒ–å€¼ï¼‰ |

âœ… **å­—æ®µçº§ç­–ç•¥ç»§æ‰¿**  
- èŠ‚ç‚¹å¯å£°æ˜ `context_merge_policy`ï¼Œè¦†ç›–å…¨å±€ç­–ç•¥  
- æ”¯æŒé€šé…è·¯å¾„ï¼ˆå¦‚ `results.*`ï¼‰å’Œç²¾ç¡®è·¯å¾„ï¼ˆå¦‚ `results.items`ï¼‰  
- å­å›¾ç­–ç•¥ä¼˜å…ˆäºçˆ¶å›¾

âœ… **ç»“æ„åŒ–åˆå¹¶å†²çªé”™è¯¯**  
é”™è¯¯ä¿¡æ¯å¿…é¡»åŒ…å«ï¼š  
- å†²çªå­—æ®µè·¯å¾„ï¼ˆå¦‚ `user.id`ï¼‰  
- å„å†™å…¥åˆ†æ”¯çš„å€¼ï¼ˆå¦‚ `branch_a: "u1", branch_b: "u2"`ï¼‰  
- æ¥æºèŠ‚ç‚¹è·¯å¾„ï¼ˆå¦‚ `/main/step1`, `/main/step2`ï¼‰  
- é”™è¯¯ç ï¼š`ERR_CTX_MERGE_CONFLICT`

---

### 4.2 Inja æ¨¡æ¿å¼•æ“ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰

âœ… å…è®¸ï¼šå˜é‡ã€æ¡ä»¶ã€å¾ªç¯ã€å†…ç½®å‡½æ•°ã€è¡¨è¾¾å¼ã€æ¨¡æ¿å†…èµ‹å€¼  
âŒ ç¦æ­¢ï¼š`include`/`extends`ã€ç¯å¢ƒå˜é‡ã€ä»»æ„ä»£ç æ‰§è¡Œ  
ğŸ” æ€§èƒ½ä¼˜åŒ–ï¼šæ‰§è¡Œå™¨åº”å¯¹ç›¸åŒä¸Šä¸‹æ–‡+æ¨¡æ¿ç»„åˆç¼“å­˜æ¸²æŸ“ç»“æœ

---

### 4.3 èŠ‚ç‚¹é€šç”¨å­—æ®µ

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|------|------|------|------|
| `type` | string | âœ… | èŠ‚ç‚¹ç±»å‹ |
| `next` | string æˆ– list | âš ï¸ | Inja è¡¨è¾¾å¼æˆ–è·¯å¾„åˆ—è¡¨ï¼ˆæ”¯æŒ `@v1` ç‰ˆæœ¬åç¼€ï¼‰ |
| `metadata` | map | âŒ | `description`, `author`, `tags` |
| `on_error` | string | âŒ | é”™è¯¯å¤„ç†è·³è½¬è·¯å¾„ |
| `on_timeout` | string | âŒ | è¶…æ—¶å¤„ç†è·¯å¾„ |
| `on_success` | string | âŒ | æˆåŠŸååŠ¨ä½œï¼ˆå¦‚ `archive_to("/lib/solved/...")`ï¼‰ |
| `wait_for` | list æˆ– map | âŒ | æ”¯æŒ `any_of` / `all_of` / åŠ¨æ€è¡¨è¾¾å¼ |
| `loop_until` | string | âŒ | Inja è¡¨è¾¾å¼ï¼Œæ§åˆ¶å¾ªç¯ |
| `max_loop` | integer | âŒ | æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼ˆé»˜è®¤ 10ï¼‰ |
| `context_merge_policy` | map | âŒ | å­—æ®µçº§åˆå¹¶ç­–ç•¥ |
| `permissions` | list | âŒ | èŠ‚ç‚¹æ‰€éœ€æƒé™å£°æ˜ï¼ˆè§ 7.2ï¼‰ |
| `expected_output` | map | âŒ | å£°æ˜æœŸæœ›è¾“å‡ºï¼ˆç”¨äºéªŒè¯/è®­ç»ƒï¼‰ |
| `curriculum_level` | string | âŒ | è¯¾ç¨‹éš¾åº¦æ ‡ç­¾ï¼ˆå¦‚ `beginner`ï¼‰ |

> âŒ **ç§»é™¤ `dev_comment`**ï¼šå»ºè®®ä½¿ç”¨æ ‡å‡† Markdown æ³¨é‡Šï¼ˆå¦‚ `<!-- debug: ... -->`ï¼‰

---

## äº”ã€æ ¸å¿ƒå¶å­èŠ‚ç‚¹å®šä¹‰ï¼ˆæ‰§è¡ŒåŸè¯­å±‚ï¼‰

### 5.1 `assign`
- **è¯­ä¹‰**ï¼šå®‰å…¨èµ‹å€¼åˆ°ä¸Šä¸‹æ–‡ï¼ˆInja è¡¨è¾¾å¼ï¼‰
- **å…³é”®å­—æ®µ**ï¼š`assign.expr`, `assign.path`ï¼ˆå¯é€‰ï¼‰
- **ç¤ºä¾‹**ï¼š
  ```yaml
  type: assign
  assign:
    expr: "{{ $.a + $.b }}"
    path: "result.sum"
  ```

### 5.2 `tool_call`
- **è¯­ä¹‰**ï¼šè°ƒç”¨æ³¨å†Œå·¥å…·ï¼ˆå¸¦æƒé™æ£€æŸ¥ï¼‰
- **å…³é”®å­—æ®µ**ï¼š`tool`, `arguments`, `output_mapping`
- **æƒé™è¦æ±‚**ï¼šå¿…é¡»å£°æ˜ `permissions`ï¼ˆå¦‚ `tool: web_search`ï¼‰

### 5.3 `codelet_call`
- **è¯­ä¹‰**ï¼šæ‰§è¡Œæ²™ç®±ä»£ç ï¼ˆå¸¦å®‰å…¨ç­–ç•¥ï¼‰
- **å…³é”®å­—æ®µ**ï¼š`runtime`, `code`, `security`
- **æƒé™è¦æ±‚**ï¼šå¿…é¡»å£°æ˜ `permissions`ï¼ˆå¦‚ `runtime: python3`ï¼‰

### 5.4 `assert`
- **è¯­ä¹‰**ï¼šéªŒè¯æ¡ä»¶ï¼Œå¤±è´¥åˆ™è·³è½¬
- **å…³é”®å­—æ®µ**ï¼š`condition`ï¼ˆInja å¸ƒå°”è¡¨è¾¾å¼ï¼‰, `on_failure`
- **ç¤ºä¾‹**ï¼š
  ```yaml
  type: assert
  condition: "len($.roots) == 1"
  on_failure: "/self/repair"
  ```

### 5.5 `fork` / `join`
- **è¯­ä¹‰**ï¼šæ˜¾å¼å¹¶è¡Œæ§åˆ¶
- **å…³é”®å­—æ®µ**ï¼š
  - `fork.branches`: è·¯å¾„åˆ—è¡¨
  - `join.wait_for`: ä¾èµ–åˆ—è¡¨, `merge_strategy`
- **ä¾èµ–è§£ææ—¶æœº**ï¼šæ‰§è¡Œå™¨å¿…é¡»åœ¨èŠ‚ç‚¹å…¥è°ƒåº¦é˜Ÿåˆ—å‰è§£æ `wait_for` è¡¨è¾¾å¼  
- **ç¦æ­¢**ï¼šåœ¨æ‰§è¡Œä¸­åŠ¨æ€å˜æ›´ä¾èµ–æ‹“æ‰‘

### 5.6 `end`
- **è¯­ä¹‰**ï¼šç»ˆæ­¢å½“å‰å­å›¾
- **å…³é”®å­—æ®µ**ï¼š
  - `termination_mode`: `hard`ï¼ˆé»˜è®¤ï¼‰æˆ– `soft`
  - `output_keys`: ä»…åˆå¹¶æŒ‡å®šå­—æ®µåˆ°çˆ¶ä¸Šä¸‹æ–‡ï¼ˆ`soft` æ¨¡å¼ï¼‰
- **`soft` è¯­ä¹‰**ï¼š  
  > æ‰§è¡Œå™¨ç»´æŠ¤è°ƒç”¨æ ˆã€‚`soft end` å¼¹å‡ºæ ˆé¡¶ï¼Œè·³è½¬è‡³è°ƒç”¨è€…çš„ `next` èŠ‚ç‚¹ã€‚è‹¥æ ˆç©ºï¼Œåˆ™ç­‰åŒ `hard`ã€‚

### 5.7 `generate_subgraph`ï¼ˆv3.0 æ–°å¢ï¼ŒåŸ `llm_call`ï¼‰
- **è¯­ä¹‰**ï¼š**å§”æ‰˜ LLM ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„å¯æ‰§è¡Œå­å›¾ï¼ˆDAG ç‰‡æ®µï¼‰**  
  > âš ï¸ **ä¸å¾—ç”¨äºè°ƒç”¨å·²æœ‰å­å›¾æˆ–ç”Ÿæˆè‡ªç„¶è¯­è¨€ï¼**
- **å…³é”®å­—æ®µ**ï¼š
  - `prompt_template`
  - `output_constraints`ï¼ˆå¦‚ `must_include_signature`ï¼‰
  - `signature_validation`: `strict`ï¼ˆé»˜è®¤ï¼‰, `warn`, `ignore`
  - `on_signature_violation`: ç­¾åéªŒè¯å¤±è´¥è·³è½¬è·¯å¾„
- **æ‰§è¡Œå™¨è¡Œä¸º**ï¼š
  1. æ³¨å…¥ `available_subgraphs`ï¼ˆå« `signature`ï¼‰åˆ° prompt
  2. è§£æ LLM è¾“å‡ºçš„ `### AgenticDSL '/dynamic/...'` å—
  3. æ³¨å†Œåˆ° `/dynamic/**` å‘½åç©ºé—´
  4. è‹¥å£°æ˜ `signature`ï¼ŒæŒ‰ç­–ç•¥æ ¡éªŒ

### 5.8 `start` / `resource`
- `start`ï¼šæ— æ“ä½œï¼Œè·³è½¬åˆ° `next`
- `resource`ï¼š**å£°æ˜å¼ä¾èµ–**ï¼ˆéæ‰§è¡ŒèŠ‚ç‚¹ï¼‰ï¼Œæ‰§è¡Œå™¨åœ¨**è°ƒåº¦å‰æ£€æŸ¥**èµ„æºå¯ç”¨æ€§ï¼ˆå‡­æ®ã€ç½‘ç»œã€æƒé™ï¼‰

---

## å…­ã€ç»Ÿä¸€æ–‡æ¡£ç»“æ„

### 6.1 è·¯å¾„åŒ–å­å›¾å—ï¼ˆæ ¸å¿ƒå•å…ƒï¼‰

- æ‰€æœ‰é€»è¾‘å•å…ƒå‡ä¸º **`### AgenticDSL '/path'` å—**
- `.agent.md` æ–‡ä»¶æ˜¯**å¤šä¸ªå­å›¾å—çš„ç‰©ç†æ‰“åŒ…æ ¼å¼**
- è·¯å¾„å‘½åç©ºé—´ï¼š
  - `/lib/**`ï¼š**é™æ€æ ‡å‡†åº“**ï¼ˆå¿…é¡»å¸¦ `signature`ï¼‰
    - `/lib/reasoning/**`ï¼šæ¨ç†åŸè¯­ï¼ˆè§„èŒƒç»´æŠ¤ï¼‰
    - `/lib/workflow/**`ï¼šè¡ŒåŠ¨æµæ¨¡å—
    - `/lib/knowledge/**`ï¼šçŸ¥è¯†å•å…ƒ
    - `/lib/human/**`ï¼šäººæœºåä½œæ¨¡å—
  - `/dynamic/**`ï¼š**è¿è¡Œæ—¶ç”Ÿæˆå­å›¾**
  - `/main/**`ï¼šä¸»æµç¨‹

### 6.2 å­å›¾ç­¾åï¼ˆSubgraph Signatureï¼‰

æ‰€æœ‰ `/lib/**` å­å›¾ **å¿…é¡»** å£°æ˜ç»“æ„åŒ–æ¥å£å¥‘çº¦ï¼š

```yaml
signature:
  inputs:
    - name: expr
      type: string
      required: true
  outputs:
    - name: roots
      type: array
      schema:  # âœ… å¼ºåˆ¶ JSON Schema Draft 7+
        type: array
        items: { type: number }
        minItems: 1
  version: "1.0"
  stability: stable  # stable / experimental / deprecated
```

- **`signature.outputs`**ï¼šå®šä¹‰æ¥å£å¥‘çº¦ï¼ˆè°ƒç”¨å‰åæ ¡éªŒï¼‰
- **`expected_output`**ï¼šå®šä¹‰å•æ¬¡ä»»åŠ¡æœŸæœ›å€¼ï¼ˆç”¨äº Trace éªŒè¯ï¼‰

### 6.3 LLM æ„å›¾ç»“æ„åŒ–

```html
<!-- LLM_INTENT: {"task": "user_clarification", "domain": "ecommerce"} -->
```

- æ‰§è¡Œå™¨å¿…é¡»è§£æä¸º JSON å¹¶è®°å½•åˆ° trace
- è‹¥æ ¼å¼éæ³•ï¼Œè®°å½•ä¸ºåŸå§‹å­—ç¬¦ä¸²å¹¶å‘Šè­¦

---

## ä¸ƒã€å®‰å…¨ä¸å·¥ç¨‹ä¿éšœ

### 7.1 æ ‡å‡†åº“å¥‘çº¦å¼ºåˆ¶

- æ‰€æœ‰ `/lib/**` å­å›¾ **å¿…é¡»** å£°æ˜ `signature`
- æ‰§è¡Œå™¨å¯åŠ¨æ—¶é¢„åŠ è½½å¹¶æ ¡éªŒæ‰€æœ‰æ ‡å‡†åº“
- LLM ç”Ÿæˆæ—¶ï¼Œ`available_subgraphs` å¿…é¡»åŒ…å« `signature` ä¿¡æ¯

### 7.2 æƒé™ä¸æ²™ç®±

èŠ‚ç‚¹æˆ–å­å›¾å¯å£°æ˜ `permissions`ï¼š

```yaml
permissions:
  - tool: web_search â†’ scope: read_only
  - runtime: python3 â†’ allow_imports: [json, re]
  - network: outbound â†’ domains: ["api.example.com"]
  - generate_subgraph: { max_depth: 2 }
```

- æ‰§è¡Œå™¨å¯¹ `/lib/**` å¯ç”¨**æœ€å°æƒé™æ²™ç®±**
- æœªæˆæƒè¡Œä¸º â†’ ç«‹å³ç»ˆæ­¢å¹¶è·³è½¬ `on_error`

### 7.3 å¯è§‚æµ‹æ€§ï¼ˆTrace Schemaï¼‰

æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œåç”Ÿæˆç»“æ„åŒ– Traceï¼ˆOpenTelemetry å…¼å®¹ï¼‰ï¼š

```json
{
  "trace_id": "t-12345",
  "node_path": "/lib/reasoning/assert_real_root",
  "type": "assert",
  "start_time": "2025-10-23T10:00:00Z",
  "end_time": "2025-10-23T10:00:02Z",
  "status": "failed",
  "error_code": "ERR_ASSERT_FAILED",
  "context_delta": { "is_valid": false },
  "expected_output": { "roots": ["-1"] },
  "output_match": false,
  "suggested_fix": "è¯·å°†æ–¹ç¨‹é‡å†™ä¸ºæ ‡å‡†å½¢å¼ ax^2 + bx + c = 0",
  "llm_intent": { "task": "math_reasoning" },
  "lib_version": "1.0",
  "node_type": "standard_library",
  "mode": "dev",
  "budget_snapshot": { "nodes_used": 5, "subgraph_depth": 1 }
}
```

### 7.4 æ ‡å‡†åº“ç‰ˆæœ¬ä¸ä¾èµ–ç®¡ç†

- è·¯å¾„æ”¯æŒè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼š`next: "/lib/human/clarify_intent@v1"`
- å­å›¾å¯å£°æ˜ä¾èµ–ï¼š
  ```yaml
  requires:
    - lib: "/lib/reasoning/verify_solution@^1.0"
  ```
- æ‰§è¡Œå™¨å¯åŠ¨æ—¶è§£æä¾èµ–å›¾ï¼Œæ‹’ç»å¾ªç¯æˆ–ç¼ºå¤±ä¾èµ–

---

## å…«ã€æ ¸å¿ƒèƒ½åŠ›è§„èŒƒ

### 8.1 åŠ¨æ€ DAG æ‰§è¡Œ + å…¨å±€é¢„ç®—

- `execution_budget`ï¼š`max_nodes`, `max_subgraph_depth`, `max_duration_sec`
- è¶…é™ â†’ è·³è½¬ `/__system__/budget_exceeded`
- **ç»ˆæ­¢æ¡ä»¶**ï¼šé˜Ÿåˆ—ç©º + æ— æ´»è·ƒç”Ÿæˆ + æ— å¾…åˆå¹¶å­å›¾ + é¢„ç®—æœªè¶…

### 8.2 åŠ¨æ€å­å›¾ç”Ÿæˆï¼ˆ`generate_subgraph` æ ¸å¿ƒæœºåˆ¶ï¼‰

- LLM **å¿…é¡»è¾“å‡ºä¸€ä¸ªæˆ–å¤šä¸ª `### AgenticDSL '/dynamic/...'` å—**
- æ‰§è¡Œå™¨è§£æä¸ºå­å›¾å¯¹è±¡ï¼Œæ³¨å†Œåˆ° `/dynamic/**` å‘½åç©ºé—´
- è‹¥å£°æ˜ `signature`ï¼Œåˆ™æŒ‰ `signature_validation` ç­–ç•¥æ ¡éªŒ
- æ–°å­å›¾å¯è¢«åç»­èŠ‚ç‚¹é€šè¿‡ `next: "/dynamic/plan_123"` è°ƒç”¨

### 8.3 å¹¶å‘ä¸ä¾èµ–è¡¨è¾¾

- `wait_for` æ”¯æŒ `any_of` / `all_of`
- æ”¯æŒåŠ¨æ€ä¾èµ–ï¼š`wait_for: "{{ dynamic_branches }}"`
- âœ… **ä¾èµ–è§£ææ—¶æœº**ï¼šæ‰§è¡Œå™¨å¿…é¡»åœ¨èŠ‚ç‚¹å…¥è°ƒåº¦é˜Ÿåˆ—å‰è§£æ `wait_for` è¡¨è¾¾å¼  
- âŒ **ç¦æ­¢**ï¼šåœ¨æ‰§è¡Œä¸­åŠ¨æ€å˜æ›´ä¾èµ–æ‹“æ‰‘

### 8.4 è‡ªè¿›åŒ–æ§åˆ¶

- `on_success: archive_to("/lib/solved/{{ problem_type }}@v1")`  
  â†’ æˆåŠŸ DAG è‡ªåŠ¨å­˜å…¥å›¾åº“
- `on_error` å¯è·³è½¬è‡³ä¿®å¤å­å›¾ï¼ˆå¦‚ `/self/repair`ï¼‰
- `curriculum_level` æ”¯æŒè¯¾ç¨‹å­¦ä¹ è°ƒåº¦

### 8.5 å¼€å‘æ¨¡å¼æ”¯æŒï¼ˆv3.1 æ–°å¢ï¼‰

- åœ¨ `/__meta__` ä¸­å£°æ˜ `mode: dev | prod`
- **å¼€å‘æ¨¡å¼**ï¼ˆ`dev`ï¼‰ï¼š
  - é»˜è®¤ `signature_validation: warn`
  - å…è®¸ `last_write_wins`
  - Trace åŒ…å«è¯¦ç»†ä¸Šä¸‹æ–‡å¿«ç…§
- **ç”Ÿäº§æ¨¡å¼**ï¼ˆ`prod`ï¼Œé»˜è®¤ï¼‰ï¼š
  - å¼ºåˆ¶ `signature_validation: strict`
  - ç¦ç”¨ `last_write_wins`
  - æœ€å°æƒé™æ²™ç®±å¼ºåˆ¶å¯ç”¨

---

## ä¹ã€LLM ç”ŸæˆæŒ‡ä»¤ï¼ˆSystem Promptï¼‰

> ä½ æ˜¯ä¸€ä¸ª**æ¨ç†ä¸è¡ŒåŠ¨æ¶æ„å¸ˆ**ï¼ˆReasoning & Action Architectï¼‰ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆ**å¯æ‰§è¡Œã€å¯éªŒè¯çš„åŠ¨æ€ DAG**ï¼ŒåŒ…å«ï¼š
> - **è¡ŒåŠ¨æµ**ï¼šè°ƒç”¨å·¥å…·ã€ä¸äººåä½œ
> - **æ€ç»´æµ**ï¼šå‡è®¾ â†’ è®¡ç®— â†’ éªŒè¯
>
> **å¿…é¡»éµå®ˆ**ï¼š
> - æ°¸è¿œä¸è¦è¾“å‡ºè‡ªç„¶è¯­è¨€è§£é‡Šï¼ˆé™¤éåœ¨ `<!-- LLM: ... -->` æˆ– `<!-- LLM_INTENT: ... -->` ä¸­ï¼‰
> - **å¿…é¡»è¾“å‡ºä¸€ä¸ªæˆ–å¤šä¸ª `### AgenticDSL '/path'` å—**
> - è‹¥ä»»åŠ¡å·²å®Œæˆï¼Œè¯·ç”Ÿæˆ `end` èŠ‚ç‚¹
> - ä½ å¯ç”Ÿæˆ `generate_subgraph` èŠ‚ç‚¹ï¼Œä½†æ€»é€’å½’æ·±åº¦ä¸å¾—è¶…è¿‡ {{ budget.subgraph_depth_left }}
>
> **æ–°å¢æç¤º**ï¼š
> - ä½ å¯å£°æ˜ç»“æ„åŒ–æ„å›¾ï¼š`<!-- LLM_INTENT: {"task": "..."} -->`
> - ä½ å¿…é¡»éµå®ˆ `output_constraints`ï¼ˆå¦‚æœ‰ï¼‰
> - ä¼˜å…ˆè°ƒç”¨æ ‡å‡†åº“ï¼š

```jinja2
å¯ç”¨åº“æ¸…å•ï¼ˆå«å¥‘çº¦ï¼‰ï¼š
{% for lib in available_subgraphs %}
- {{ lib.path }} (v{{ lib.version }}): {{ lib.description }}
  Inputs: {{ lib.signature.inputs | map(attr='name') | join(', ') }}
  Outputs: {{ lib.signature.outputs | map(attr='name') | join(', ') }}
{% endfor %}
```

**å½“å‰ä¸Šä¸‹æ–‡**ï¼š
- å·²æ‰§è¡ŒèŠ‚ç‚¹ï¼š`{{ execution_context.executed_nodes }}`
- ä»»åŠ¡ç›®æ ‡ï¼š`{{ execution_context.task_goal }}`
- æ‰§è¡Œé¢„ç®—å‰©ä½™ï¼š`nodes: {{ budget.nodes_left }}, depth: {{ budget.subgraph_depth_left }}`
- ï¼ˆè®­ç»ƒæ¨¡å¼ï¼‰æœŸæœ›è¾“å‡ºï¼š`{{ expected_output }}`

---

## åã€å®Œæ•´ç¤ºä¾‹

```markdown
### AgenticDSL `/__meta__`
yaml
version: "3.1"
mode: dev  # âœ… å¼€å‘æ¨¡å¼
execution_budget:
  max_nodes: 20
  max_subgraph_depth: 2
  max_duration_sec: 30
context_merge_strategy: "error_on_conflict"

### AgenticDSL `/main/solve_equation`
yaml
type: assign
assign:
  expr: "x^2 + 2x + 1 = 0"
next: "/lib/reasoning/solve_quadratic@v1"

### AgenticDSL `/main/verify`
yaml
type: assert
condition: "len($.roots) == 1 and $.roots[0] == -1"
expected_output:
  roots: [-1]
on_success: "archive_to('/lib/solved/quadratic@v1')"
on_failure: "/self/repair"

### AgenticDSL `/self/repair`
yaml
type: generate_subgraph
prompt_template: "æ–¹ç¨‹ {{ $.expr }} æ±‚è§£å¤±è´¥ã€‚è¯·é‡å†™ä¸ºæ ‡å‡†å½¢å¼å¹¶ç”Ÿæˆæ–°DAGã€‚"
signature_validation: warn
on_signature_violation: "/self/fallback"
next: "/dynamic/repair_123"

### AgenticDSL `/lib/human/approval`  # âœ… Core SDK ç¤ºä¾‹
yaml
signature:
  inputs:
    - name: request
      type: string
      required: true
  outputs:
    - name: approved
      type: boolean
      required: true
    - name: comment
      type: string
      schema: { type: string }
  version: "1.0"
  stability: stable
type: tool_call
tool: human_approval
arguments:
  message: "{{ $.request }}"
output_mapping:
  approved: "result.approved"
  comment: "result.comment"
```

---

## é™„å½• Aï¼šæœ€ä½³å®è·µä¸çº¦å®š

### A1. æ—¶é—´ä¸Šä¸‹æ–‡çº¦å®šï¼ˆéå¼ºåˆ¶ï¼‰
- `$.now`: ISO8601 å½“å‰æ—¶é—´ï¼ˆç”±æ‰§è¡Œå™¨æ³¨å…¥ï¼‰
- `$.time_anchor`: ä»»åŠ¡å‚è€ƒæ—¶é—´ç‚¹
- `$.timeline[]`: `{ts: "...", event: "...", source: "..."}`

### A2. ç¦æ­¢è¡Œä¸ºæ¸…å•
- åœ¨ DAG å†…å®ç°å¼‚æ­¥å›è°ƒ
- åœ¨å¶å­èŠ‚ç‚¹ä¸­ç¼–ç é«˜å±‚æ¨ç†é€»è¾‘
- ä½¿ç”¨ `generate_subgraph` è°ƒç”¨å·²æœ‰å­å›¾
- è¾“å‡ºé `### AgenticDSL` å—çš„ LLM å†…å®¹
- åœ¨ç”Ÿäº§æ¨¡å¼ä¸‹ä½¿ç”¨ `last_write_wins` åˆå¹¶ç­–ç•¥

### A3. æ¨èå·¥å…·é“¾
- **éªŒè¯å™¨**ï¼šæ ¡éªŒ `.agent.md` æ–‡ä»¶è¯­æ³•ä¸å¥‘çº¦
- **å¯è§†åŒ–å™¨**ï¼šæ¸²æŸ“ DAG æ‰§è¡Œè·¯å¾„
- **è®­ç»ƒå™¨**ï¼šä» Trace ä¸­æå– `(input, expected_output, actual_output)` ä¸‰å…ƒç»„
- **æ¨¡æ‹Ÿå™¨**ï¼šdry-run æ¨¡å¼æµ‹è¯• DAG è¡Œä¸º

---

## é™„å½• Bï¼š`expected_output` ä¸ `signature.outputs` åˆ†å·¥è¯´æ˜

| æœºåˆ¶ | ä½œç”¨åŸŸ | ç”¨é€” | æ ¡éªŒæ—¶æœº |
|------|--------|------|--------|
| `signature.outputs` | **å­å›¾æ¥å£** | å¥‘çº¦ï¼šè°ƒç”¨è€…ä¸è¢«è°ƒç”¨è€…çº¦å®š | è°ƒç”¨å‰ï¼ˆè¾“å…¥ï¼‰ã€è°ƒç”¨åï¼ˆè¾“å‡ºï¼‰ |
| `expected_output` | **å•æ¬¡æ‰§è¡Œ** | éªŒè¯ï¼šæœ¬æ¬¡ä»»åŠ¡æœŸæœ›çš„å…·ä½“å€¼ | æ‰§è¡Œåï¼ˆTrace è®°å½•ï¼Œå¯é€‰å‘Šè­¦ï¼‰ |

---

## é™„å½• Cï¼šæ ¸å¿ƒæ ‡å‡†åº“ï¼ˆCore SDKï¼‰v3.1 å¿…é¡»å®ç°æ¸…å•

| è·¯å¾„ | ç”¨é€” | ç¨³å®šæ€§ |
|------|------|--------|
| `/lib/reasoning/assert` | ä¸­é—´ç»“è®ºéªŒè¯ | stable |
| `/lib/human/clarify_intent` | è¯·æ±‚ç”¨æˆ·æ¾„æ¸…æ„å›¾ | stable |
| `/lib/human/approval` | äººå·¥å®¡æ‰¹èŠ‚ç‚¹ | stable |
| `/lib/workflow/parallel_map` | åŸºäº `fork` çš„ map å°è£… | experimental |
| `/lib/reasoning/solve_quadratic` | äºŒæ¬¡æ–¹ç¨‹æ±‚è§£ç¤ºä¾‹ | experimental |

> æ‰§è¡Œå™¨å¿…é¡»é¢„åŠ è½½å¹¶æ ¡éªŒä»¥ä¸Šå­å›¾ã€‚ç¤¾åŒºå¯æ‰©å±•ï¼Œä½†ä¸å¾—ä¿®æ”¹å…¶ `signature`ã€‚

---

> **AgenticDSL v3.1 æ˜¯è¿ˆå‘ AI åŸç”Ÿæ“ä½œç³»ç»Ÿçš„åšå®ä¸€æ­¥ã€‚**  
> å®ƒä¸ä»…å®šä¹‰äº†â€œå¦‚ä½•è¿è¡Œæ€ç»´â€ï¼Œæ›´é€šè¿‡ **ä¸‰å±‚æŠ½è±¡ + Core SDK + å¼€å‘æ¨¡å¼ + JSON Schema å¥‘çº¦**ï¼Œ  
> ä¸ºæ„å»º**å¯é ã€å¯åä½œã€å¯è¿›åŒ–çš„æ™ºèƒ½ä½“ç”Ÿæ€**æä¾›äº†å·¥ç¨‹åŸºçŸ³ã€‚

---  
**Â© 2025 AgenticDSL Working Group. All rights reserved.**  
*æœ¬è§„èŒƒé‡‡ç”¨ CC BY-SA 4.0 è®¸å¯ï¼Œæ¬¢è¿ç¤¾åŒºå…±å»ºã€‚*
